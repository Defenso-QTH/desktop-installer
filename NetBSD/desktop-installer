#!/bin/sh -e

##########################################################################
#   Description:
#       NetBSD desktop-installer
#
#   History:
#   Date        Name        Modification
#   2023-06-10  Charlie &,,,Begin
##########################################################################

usage()
{
    printf "Usage: $0\n"
    exit 1
}


##########################################################################
#   Main
##########################################################################

if [ $# != 0 ]; then
    usage
fi

# Should have been installed as a dep, but just in case
pkgin -y install auto-admin
pkgin -y install digest fetch git cvs gmake xz feh tk

if ! auto-package-installed security/mozilla-rootcerts-openssl; then
    printf "Install mozilla root certs? (Needed to access many sites) [y]/n "
    read mz
    if [ 0$"mz" != 0n ]; then
	pkgin -y install mozilla-rootcerts-openssl
    fi
fi

for base_set in comp man xbase xetc xcomp xfont xserver; do
    if [ ! -e /etc/mtree/set.$base_set ]; then
	printf "Installing $set...\n"
	auto-install-base-components $base_set
    else
	printf "$base_set already installed.\n"
    fi
done

if [ ! -e /usr/pkgsrc ]; then
    printf "Installing pkgsrc tree...\n"
    cd /usr
    ftp ftp://ftp.netbsd.org/pub/pkgsrc/stable/pkgsrc.tar.xz
    tar -zxvf pkgsrc.tar.xz
fi

if [ ! -e /usr/pkgsrc/wip ]; then
    printf "Install pkgsrc-wip? y/[n] "
    read wip
    if [ 0"$wip" = 0y ]; then
	cd /usr/pkgsrc
	auto-pkgsrc-wip-checkout
    fi
fi

cat << EOM

1.. CTWM (NetBSD default)
2.. Gnome
3.. KDE
4.. LXDE
5.. LXQT
6.. MATE
7.. XFCE

EOM
printf "Selection? "
read de

XDM_CONF=/etc/X11/xdm/xdm-config
xsession=/etc/X11/xdm/Xsession

case $de in
1)
    if [ -e $xsession.ctwm ]; then
	mv -f $xsession.ctwm $xsession
    fi
    pkgin install evince
    ;;

2)
    pkgin -y install gnome evince
    # FIXME: Use auto-something
    if [ ! -e $xsession.ctwm ]; then
	mv $xsession $xsession.ctwm
    fi
    echo 'exec gnome-session' > $xsession
    
    cat << EOM > $HOME/.xinitrc
#!/bin/sh -e

/usr/pkg/bin/gnome-session
EOM
    fgrep -q 'DisplayManager*authName' $XDM_CONF || echo 'DisplayManager*authName: MIT-MAGIC-COOKIE-1' >> $XDM_CONF
    ;;

3)
    pkgin -y install kde

    # FIXME: Use auto-something
    if [ ! -e $xsession.ctwm ]; then
	mv $xsession $xsession.ctwm
    fi
    echo 'exec startkde' > $xsession
    
    cat << EOM > $HOME/.xinitrc
#!/bin/sh -e

/usr/pkg/bin/startlxde
EOM
    fgrep -q 'DisplayManager*authName' $XDM_CONF || echo 'DisplayManager*authName: MIT-MAGIC-COOKIE-1' >> $XDM_CONF
    ;;

4)
    pkgin -y install lxde evince

    # FIXME: Use auto-something
    if [ ! -e $xsession.ctwm ]; then
	mv $xsession $xsession.ctwm
    fi
    echo 'exec startlxde' > $xsession
    
    cat << EOM > $HOME/.xinitrc
#!/bin/sh -e

/usr/pkg/bin/startlxde
EOM
    fgrep -q 'DisplayManager*authName' $XDM_CONF || echo 'DisplayManager*authName: MIT-MAGIC-COOKIE-1' >> $XDM_CONF
    ;;

5)
    pkgin -y install lxqt evince

    # FIXME: Use auto-something
    if [ ! -e $xsession.ctwm ]; then
	mv $xsession $xsession.ctwm
    fi
    echo 'exec lxtq-session' > $xsession
    
    cat << EOM > $HOME/.xinitrc
#!/bin/sh -e

/usr/pkg/bin/startlxqt
EOM
    fgrep -q 'DisplayManager*authName' $XDM_CONF || echo 'DisplayManager*authName: MIT-MAGIC-COOKIE-1' >> $XDM_CONF
    ;;

6)
    pkgin -y install mate evince

    # FIXME: Use auto-something
    if [ ! -e $xsession.ctwm ]; then
	mv $xsession $xsession.ctwm
    fi
    echo 'exec mate-session' > $xsession
    
    cat << EOM > $HOME/.xinitrc
#!/bin/sh -e

/usr/pkg/bin/mate-session
EOM
    fgrep -q 'DisplayManager*authName' $XDM_CONF || echo 'DisplayManager*authName: MIT-MAGIC-COOKIE-1' >> $XDM_CONF
    ;;

7)
    pkgin -y install xfce4 evince

    # FIXME: Use auto-something
    if [ ! -e $xsession.ctwm ]; then
	mv $xsession $xsession.ctwm
    fi
    echo 'exec xfce4-session' > $xsession
    
    cat << EOM > $HOME/.xinitrc
#!/bin/sh -e

/usr/pkg/bin/startxfce4
EOM
    fgrep -q 'DisplayManager*authName' $XDM_CONF || echo 'DisplayManager*authName: MIT-MAGIC-COOKIE-1' >> $XDM_CONF
    ;;

*)
    printf "Invalid selection.\n"
    exit 1
    ;;

esac

##########################################################################
#   From guide
##########################################################################

cp /usr/pkg/share/examples/rc.d/dbus /etc/rc.d
# FIXME: Use auto-enable-service
auto-enable-service dbus $0

# Enhanced XDM with background and restart/shutdown/restart-x11 buttons
auto-replace-file /usr/pkg/share/desktop-installer/XDM/Xsetup_0 /etc/X11/xdm/Xsetup_0
auto-replace-file /usr/pkg/share/desktop-installer/XDM/GiveConsole /etc/X11/xdm/GiveConsole

cat << EOM

Enabling XDM will cause the screen to switch to graphics mode.

If you are running desktop-installer on the primary text console,
you can return to the text console by typing Ctrl+Alt+F1 on most
systems (or Meta-key + F1 under VirtualBox).

EOM
printf "Enable XDM graphical login? [y]/n "
read xdm
if [ 0"$xdm" != 0n ]; then
    auto-enable-service xdm $0
fi

for app in www/firefox mail/thunderbird security/keepassxc; do
    if ! auto-package-installed $app; then
	printf "Install $app? y/[n] "
	read install
	if [ 0"$install" = 0y ]; then
	    apps="$apps ${app#*/}"
	fi
    fi
done
if [ ! -z "$apps" ]; then
    pkgin -y install $apps
fi
