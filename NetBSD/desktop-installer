#!/bin/sh -e

##########################################################################
#   Description:
#       NetBSD desktop-installer
#
#   History:
#   Date        Name        Modification
#   2023-06-10  Charlie &,,,Begin
##########################################################################

usage()
{
    printf "Usage: $0\n"
    exit 1
}


##########################################################################
#   Main
##########################################################################

if [ $# != 0 ]; then
    usage
fi

pkgin -y install auto-admin     # Should be installed as a dep
pkgin -y install digest fetch git cvs gmake xz feh tk

for base_set in comp man xbase xetc xcomp xfont xserver; do
    if [ ! -e /etc/mtree/set.$base_set ]; then
	printf "Installing $set...\n"
	auto-install-base-components $base_set
    else
	printf "$base_set already installed.\n"
    fi
done

if [ ! -e /usr/pkgsrc ]; then
    cd /usr
    ftp ftp://ftp.netbsd.org/pub/pkgsrc/stable/pkgsrc.tar.xz
    tar -zxvf pkgsrc.tar.xz
fi

if [ ! -e /usr/pkgsrc/wip ]; then
    printf "Install pkgsrc-wip? y/[n] "
    read wip
    if [ 0"$wip" = 0y ]; then
	cd /usr/pkgsrc
	auto-pkgsrc-wip-checkout
    fi
fi

cat << EOM

1.. CTWM (NetBSD default)
2.. Gnome
3.. KDE
4.. LXDE
5.. LXQT
6.. MATE
7.. XFCE

EOM
printf "Selection? "
read de

XDM_CONF=/etc/X11/xdm/xdm-config
xsession=/etc/X11/xdm/Xsession

case $de in
1)
    if [ -e $xsession.ctwm ]; then
	mv -f $xsession.ctwm $xsession
    fi
    ;;

2)
    pkgin -y install gnome
    # FIXME: Use auto-something
    if [ ! -e $xsession.ctwm ]; then
	mv $xsession $xsession.ctwm
    fi
    echo 'exec gnome-session' > $xsession
    
    cat << EOM > $HOME/.xinitrc
#!/bin/sh -e

/usr/pkg/bin/gnome-session
EOM
    fgrep -q 'DisplayManager*authName' $XDM_CONF || echo 'DisplayManager*authName: MIT-MAGIC-COOKIE-1' >> $XDM_CONF
    ;;

3)
    pkgin -y install kde

    # FIXME: Use auto-something
    if [ ! -e $xsession.ctwm ]; then
	mv $xsession $xsession.ctwm
    fi
    echo 'exec startkde' > $xsession
    
    cat << EOM > $HOME/.xinitrc
#!/bin/sh -e

/usr/pkg/bin/startlxde
EOM
    fgrep -q 'DisplayManager*authName' $XDM_CONF || echo 'DisplayManager*authName: MIT-MAGIC-COOKIE-1' >> $XDM_CONF
    ;;

4)
    pkgin -y install lxde

    # FIXME: Use auto-something
    if [ ! -e $xsession.ctwm ]; then
	mv $xsession $xsession.ctwm
    fi
    echo 'exec startlxde' > $xsession
    
    cat << EOM > $HOME/.xinitrc
#!/bin/sh -e

/usr/pkg/bin/startlxde
EOM
    fgrep -q 'DisplayManager*authName' $XDM_CONF || echo 'DisplayManager*authName: MIT-MAGIC-COOKIE-1' >> $XDM_CONF
    ;;

5)
    pkgin -y install lxqt

    # FIXME: Use auto-something
    if [ ! -e $xsession.ctwm ]; then
	mv $xsession $xsession.ctwm
    fi
    echo 'exec lxtq-session' > $xsession
    
    cat << EOM > $HOME/.xinitrc
#!/bin/sh -e

/usr/pkg/bin/startlxqt
EOM
    fgrep -q 'DisplayManager*authName' $XDM_CONF || echo 'DisplayManager*authName: MIT-MAGIC-COOKIE-1' >> $XDM_CONF
    ;;

6)
    pkgin -y install mate

    # FIXME: Use auto-something
    if [ ! -e $xsession.ctwm ]; then
	mv $xsession $xsession.ctwm
    fi
    echo 'exec mate-session' > $xsession
    
    cat << EOM > $HOME/.xinitrc
#!/bin/sh -e

/usr/pkg/bin/mate-session
EOM
    fgrep -q 'DisplayManager*authName' $XDM_CONF || echo 'DisplayManager*authName: MIT-MAGIC-COOKIE-1' >> $XDM_CONF
    ;;

7)
    pkgin -y install xfce4

    # FIXME: Use auto-something
    if [ ! -e $xsession.ctwm ]; then
	mv $xsession $xsession.ctwm
    fi
    echo 'exec xfce4-session' > $xsession
    
    cat << EOM > $HOME/.xinitrc
#!/bin/sh -e

/usr/pkg/bin/startxfce4
EOM
    fgrep -q 'DisplayManager*authName' $XDM_CONF || echo 'DisplayManager*authName: MIT-MAGIC-COOKIE-1' >> $XDM_CONF
    ;;

*)
    printf "Invalid selection.\n"
    exit 1
    ;;

esac

##########################################################################
#   From guide
##########################################################################

cp /usr/pkg/share/examples/rc.d/dbus /etc/rc.d
# FIXME: Use auto-enable-service
fgrep -q dbus= /etc/rc.conf || echo "dbus=YES" >> /etc/rc.conf
service dbus restart

fgrep -q xdm= /etc/rc.conf || echo "xdm=YES" >> /etc/rc.conf

# Enhanced XDM with background and restart/shutdown/restart-x11 buttons
auto-replace-file /usr/pkg/share/desktop-installer/XDM/Xsetup_0 /etc/X11/xdm/Xsetup_0
auto-replace-file /usr/pkg/share/desktop-installer/XDM/GiveConsole /etc/X11/xdm/GiveConsole

if ! ps ax | grep bin/xdm | grep -v grep; then
    service xdm restart
fi

for app in firefox thunderbird keepassxc; do
    printf "Install $app? y/[n] "
    read install
    if [ 0"$install" = 0y ]; then
	pkgin -y install $app
    fi
done
